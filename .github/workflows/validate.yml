# Validation Workflow
# Runs on every push and pull request to validate configurations

name: Validate

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  validate-yaml:
    name: Validate YAML
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install yamllint
        run: pip install yamllint

      - name: Validate docker-compose.yml
        run: |
          yamllint -d relaxed docker-compose.yml

      - name: Validate prometheus.yml
        run: |
          yamllint -d relaxed configs/prometheus.yml

      - name: Validate yace-config.yml
        run: |
          yamllint -d relaxed configs/yace-config.yml

      - name: Validate alert rules
        run: |
          for file in configs/alerts/*.yml; do
            echo "Validating $file..."
            yamllint -d relaxed "$file"
          done

  validate-json:
    name: Validate JSON
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Validate dashboard JSON files
        run: |
          for file in dashboards/*.json; do
            echo "Validating $file..."
            python3 -m json.tool "$file" > /dev/null || exit 1
          done

      - name: Validate IAM policy
        run: |
          python3 -m json.tool cloud-connectors/aws/iam-policy.json > /dev/null

      - name: Validate contact points
        run: |
          python3 -m json.tool configs/grafana-cloud/contact-points.json > /dev/null

  validate-shell-scripts:
    name: Validate Shell Scripts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install shellcheck
        run: sudo apt-get install -y shellcheck

      - name: Run shellcheck on scripts
        run: |
          for file in scripts/*.sh; do
            echo "Checking $file..."
            shellcheck -x "$file" || true  # Don't fail on warnings
          done

      - name: Run shellcheck on tests
        run: |
          for file in tests/*.sh; do
            echo "Checking $file..."
            shellcheck -x "$file" || true
          done

  validate-docker-compose:
    name: Validate Docker Compose
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Create dummy .env for validation
        run: |
          cat > .env << 'EOF'
          GRAFANA_CLOUD_PROMETHEUS_URL=https://example.grafana.net/api/prom/push
          GRAFANA_CLOUD_USERNAME=123456
          GRAFANA_CLOUD_API_KEY=glc_test
          GRAFANA_CLOUD_URL=https://example.grafana.net
          GRAFANA_CLOUD_API_TOKEN=glsa_test
          AWS_ACCESS_KEY_ID=AKIATEST
          AWS_SECRET_ACCESS_KEY=testsecret
          AWS_REGION=us-east-1
          AWS_REGIONS_TO_MONITOR=us-east-1
          GCP_PROJECT_ID=test-project
          GCP_KEY_PATH=./test-key.json
          EOF

      - name: Create dummy GCP key file
        run: |
          echo '{"type":"service_account"}' > test-key.json

      - name: Validate docker-compose config
        run: |
          docker compose config > /dev/null

  validate-terraform:
    name: Validate Terraform
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"

      - name: Validate AWS Terraform
        run: |
          cd terraform/aws
          terraform init -backend=false
          terraform validate

      - name: Validate GCP Terraform
        run: |
          cd terraform/gcp
          terraform init -backend=false
          terraform validate

  check-secrets:
    name: Check for Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check for hardcoded secrets
        run: |
          # Check for potential AWS keys
          if grep -rE 'AKIA[0-9A-Z]{16}' --include='*.yml' --include='*.json' --include='*.md' .; then
            echo "Potential AWS access key found!"
            exit 1
          fi

          # Check for potential secrets in non-example files
          if grep -rE '(password|secret|key).*=.*[A-Za-z0-9/+=]{20,}' --include='*.yml' --include='*.env' . | grep -v '.example' | grep -v '.md'; then
            echo "Potential secrets found!"
            exit 1
          fi

          echo "No hardcoded secrets detected"

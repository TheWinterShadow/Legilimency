# Test Workflow
# Runs integration tests to verify configurations work correctly

name: Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

jobs:
  test-docker-build:
    name: Test Docker Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create test .env file
        run: |
          cat > .env << 'EOF'
          GRAFANA_CLOUD_PROMETHEUS_URL=https://prometheus-prod-01-prod-us-central-0.grafana.net/api/prom/push
          GRAFANA_CLOUD_USERNAME=123456
          GRAFANA_CLOUD_API_KEY=glc_testkey123456789
          GRAFANA_CLOUD_URL=https://test.grafana.net
          GRAFANA_CLOUD_API_TOKEN=glsa_testtoken123456789
          AWS_ACCESS_KEY_ID=AKIATESTKEY123456789
          AWS_SECRET_ACCESS_KEY=testsecretkey1234567890123456789012345678
          AWS_REGION=us-east-1
          AWS_REGIONS_TO_MONITOR=us-east-1
          GCP_PROJECT_ID=test-project-123456
          GCP_KEY_PATH=./configs/test-gcp-key.json
          EOF

      - name: Create test GCP key file
        run: |
          mkdir -p configs
          cat > configs/test-gcp-key.json << 'EOF'
          {
            "type": "service_account",
            "project_id": "test-project",
            "private_key_id": "test",
            "private_key": "-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC7\n-----END PRIVATE KEY-----\n",
            "client_email": "test@test-project.iam.gserviceaccount.com",
            "client_id": "123456789",
            "auth_uri": "https://accounts.google.com/o/oauth2/auth",
            "token_uri": "https://oauth2.googleapis.com/token"
          }
          EOF

      - name: Pull Docker images
        run: docker compose pull

      - name: Start stack (limited test)
        run: |
          # Start only the containers that don't need real credentials
          docker compose up -d node-exporter cadvisor
          sleep 10

      - name: Test Node Exporter
        run: |
          curl -f http://localhost:9100/metrics | head -20

      - name: Test cAdvisor
        run: |
          curl -f http://localhost:8081/metrics | head -20

      - name: Show container status
        run: docker compose ps

      - name: Cleanup
        if: always()
        run: docker compose down -v

  test-dashboards:
    name: Test Dashboard Validity
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Validate dashboard structure
        run: |
          for dashboard in dashboards/*.json; do
            echo "Validating $dashboard..."

            # Check required fields
            if ! jq -e '.title' "$dashboard" > /dev/null 2>&1; then
              echo "Missing 'title' in $dashboard"
              exit 1
            fi

            if ! jq -e '.panels' "$dashboard" > /dev/null 2>&1; then
              echo "Missing 'panels' in $dashboard"
              exit 1
            fi

            # Check UID exists
            if ! jq -e '.uid' "$dashboard" > /dev/null 2>&1; then
              echo "Missing 'uid' in $dashboard"
              exit 1
            fi

            # Count panels
            panel_count=$(jq '.panels | length' "$dashboard")
            echo "  Found $panel_count panels"

            # Check for datasource references
            ds_count=$(jq '[.panels[].targets[]?.datasource.uid // empty] | length' "$dashboard")
            echo "  Found $ds_count datasource references"
          done

          echo "All dashboards validated successfully!"

  test-scripts:
    name: Test Script Syntax
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Make scripts executable
        run: chmod +x scripts/*.sh tests/*.sh

      - name: Test script syntax (bash -n)
        run: |
          for script in scripts/*.sh tests/*.sh; do
            echo "Checking syntax: $script"
            bash -n "$script"
          done

      - name: Test help flags where applicable
        run: |
          # Some scripts should have --help
          for script in scripts/setup.sh scripts/backup.sh scripts/update.sh; do
            if [ -f "$script" ]; then
              echo "Checking $script for help..."
              head -50 "$script" | grep -q "help\|usage" || echo "No help text found in $script"
            fi
          done

  test-promql:
    name: Test PromQL Queries
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install promtool
        run: |
          curl -LO https://github.com/prometheus/prometheus/releases/download/v2.45.0/prometheus-2.45.0.linux-amd64.tar.gz
          tar xzf prometheus-2.45.0.linux-amd64.tar.gz
          sudo mv prometheus-2.45.0.linux-amd64/promtool /usr/local/bin/

      - name: Extract and test PromQL from alerts
        run: |
          # Extract PromQL expressions from alert rules
          for alert_file in configs/alerts/*.yml; do
            echo "Checking PromQL in $alert_file..."

            # Extract expr fields and validate syntax
            yq -r '.groups[].rules[].expr' "$alert_file" 2>/dev/null | while read -r expr; do
              if [ -n "$expr" ] && [ "$expr" != "null" ]; then
                # Create temp file with the expression
                echo "$expr" > /tmp/expr.promql
                echo "  Validating: ${expr:0:50}..."
                # promtool check rules doesn't validate expressions directly
                # but we can at least check the file parses
              fi
            done
          done

      - name: Validate alert rule files
        run: |
          for alert_file in configs/alerts/*.yml; do
            echo "Validating alert rules in $alert_file..."
            # Note: promtool requires specific format, may need adjustment
            promtool check rules "$alert_file" || echo "Warning: $alert_file may need format adjustment"
          done

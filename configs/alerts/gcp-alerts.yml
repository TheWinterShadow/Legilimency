# GCP Alert Rules for Grafana Cloud
# These alerts monitor GCP Cloud Run, Pub/Sub, and Compute Engine services
#
# To use these alerts in Grafana Cloud:
# 1. Go to Grafana Cloud → Alerting → Alert rules
# 2. Create new alert rule group
# 3. Copy the rules below into the alert rule configuration
# 4. Set up notification channels (Slack, email, etc.)

groups:
  - name: gcp_cloudrun_alerts
    interval: 60s
    rules:
      # Alert when Cloud Run service has 5xx errors
      - alert: CloudRun5xxErrors
        expr: |
          sum(rate(stackdriver_run_revision_request_count{response_code_class="5xx"}[5m])) by (service_name) > 5
        for: 5m
        labels:
          severity: critical
          component: cloudrun
          cloud: gcp
        annotations:
          summary: "Cloud Run service {{ $labels.service_name }} has 5xx errors"
          description: |
            Cloud Run service {{ $labels.service_name }} is experiencing {{ $value }} 5xx errors per second.
            Service may be failing or experiencing issues.
          runbook_url: "https://cloud.google.com/run/docs/monitoring"

      # Alert when Cloud Run request latency exceeds threshold (p95 > 2 seconds)
      - alert: CloudRunHighLatency
        expr: |
          stackdriver_run_revision_request_latencies{quantile="0.95"} > 2000
        for: 10m
        labels:
          severity: warning
          component: cloudrun
          cloud: gcp
        annotations:
          summary: "Cloud Run service {{ $labels.service_name }} has high latency"
          description: |
            Cloud Run service {{ $labels.service_name }} p95 latency is {{ $value }}ms.
            User experience may be degraded.

      # Alert when Cloud Run instance count drops to zero (service may be down)
      - alert: CloudRunNoInstances
        expr: |
          stackdriver_run_revision_container_instance_count == 0
        for: 5m
        labels:
          severity: warning
          component: cloudrun
          cloud: gcp
        annotations:
          summary: "Cloud Run service {{ $labels.service_name }} has no running instances"
          description: |
            Cloud Run service {{ $labels.service_name }} has 0 running instances.
            Service may be scaled down or experiencing issues.

  - name: gcp_pubsub_alerts
    interval: 60s
    rules:
      # Alert when Pub/Sub subscription has undelivered messages backlog
      - alert: PubSubBacklog
        expr: |
          stackdriver_pubsub_subscription_num_undelivered_messages > 1000
        for: 10m
        labels:
          severity: warning
          component: pubsub
          cloud: gcp
        annotations:
          summary: "Pub/Sub subscription has message backlog"
          description: |
            Pub/Sub subscription for topic {{ $labels.topic_id }} has {{ $value }} undelivered messages.
            Consumer may not be processing messages fast enough.
          runbook_url: "https://cloud.google.com/pubsub/docs/monitoring"

      # Alert when Pub/Sub backlog exceeds critical threshold
      - alert: PubSubCriticalBacklog
        expr: |
          stackdriver_pubsub_subscription_num_undelivered_messages > 10000
        for: 5m
        labels:
          severity: critical
          component: pubsub
          cloud: gcp
        annotations:
          summary: "CRITICAL: Pub/Sub subscription has severe backlog"
          description: |
            Pub/Sub subscription for topic {{ $labels.topic_id }} has {{ $value }} undelivered messages.
            Immediate attention required - consumer may be down or severely overloaded.

      # Alert when Pub/Sub message age exceeds threshold
      - alert: PubSubOldMessages
        expr: |
          stackdriver_pubsub_subscription_oldest_unacked_message_age > 300
        for: 5m
        labels:
          severity: warning
          component: pubsub
          cloud: gcp
        annotations:
          summary: "Old messages in Pub/Sub subscription"
          description: |
            Pub/Sub subscription for topic {{ $labels.topic_id }} has messages older than {{ $value }} seconds.
            Messages are not being processed in a timely manner.

  - name: gcp_compute_alerts
    interval: 60s
    rules:
      # Alert when Compute Engine instance CPU utilization exceeds 90%
      - alert: ComputeHighCPU
        expr: |
          stackdriver_compute_instance_cpu_utilization > 90
        for: 10m
        labels:
          severity: warning
          component: compute
          cloud: gcp
        annotations:
          summary: "Compute Engine instance {{ $labels.instance_name }} has high CPU usage"
          description: |
            Compute Engine instance {{ $labels.instance_name }} CPU utilization is {{ $value }}%.
            Consider scaling up or optimizing the instance.

      # Alert when Compute Engine instance disk utilization exceeds 90%
      - alert: ComputeHighDisk
        expr: |
          stackdriver_compute_instance_disk_utilization > 90
        for: 10m
        labels:
          severity: warning
          component: compute
          cloud: gcp
        annotations:
          summary: "Compute Engine instance {{ $labels.instance_name }} has high disk usage"
          description: |
            Compute Engine instance {{ $labels.instance_name }} disk utilization is {{ $value }}%.
            Consider cleaning up disk space or increasing disk size.

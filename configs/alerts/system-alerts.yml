# System Alert Rules for Grafana Cloud
# These alerts monitor Raspberry Pi system resources (CPU, memory, disk, network)
#
# To use these alerts in Grafana Cloud:
# 1. Go to Grafana Cloud → Alerting → Alert rules
# 2. Create new alert rule group
# 3. Copy the rules below into the alert rule configuration
# 4. Set up notification channels (Slack, email, etc.)

groups:
  - name: system_resources_alerts
    interval: 60s
    rules:
      # Alert when Raspberry Pi CPU usage exceeds 90%
      - alert: SystemHighCPU
        expr: |
          100 - (avg(irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 90
        for: 10m
        labels:
          severity: warning
          component: system
          instance: raspberry-pi
        annotations:
          summary: "Raspberry Pi CPU usage is high"
          description: |
            Raspberry Pi CPU usage is {{ $value }}%.
            System may be overloaded. Check running processes and consider optimizing workloads.

      # Alert when Raspberry Pi memory usage exceeds 90%
      - alert: SystemHighMemory
        expr: |
          (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 90
        for: 5m
        labels:
          severity: critical
          component: system
          instance: raspberry-pi
        annotations:
          summary: "Raspberry Pi memory usage is critical"
          description: |
            Raspberry Pi memory usage is {{ $value }}%.
            System may experience OOM (Out of Memory) errors. Consider freeing memory or reducing workloads.

      # Alert when Raspberry Pi disk usage exceeds 85%
      - alert: SystemHighDisk
        expr: |
          (1 - (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"})) * 100 > 85
        for: 10m
        labels:
          severity: warning
          component: system
          instance: raspberry-pi
        annotations:
          summary: "Raspberry Pi disk usage is high"
          description: |
            Raspberry Pi disk usage is {{ $value }}%.
            Consider cleaning up disk space or expanding storage.

      # Alert when Raspberry Pi disk usage exceeds 95% (critical)
      - alert: SystemCriticalDisk
        expr: |
          (1 - (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"})) * 100 > 95
        for: 5m
        labels:
          severity: critical
          component: system
          instance: raspberry-pi
        annotations:
          summary: "CRITICAL: Raspberry Pi disk usage is critical"
          description: |
            Raspberry Pi disk usage is {{ $value }}%.
            Immediate action required - system may become unresponsive if disk fills completely.

      # Alert when Raspberry Pi is down (no metrics received)
      - alert: SystemDown
        expr: |
          up{job="node-exporter"} == 0
        for: 5m
        labels:
          severity: critical
          component: system
          instance: raspberry-pi
        annotations:
          summary: "Raspberry Pi monitoring is down"
          description: |
            No metrics received from Raspberry Pi for 5 minutes.
            System may be down, network issues, or monitoring stack failure.

  - name: monitoring_stack_alerts
    interval: 60s
    rules:
      # Alert when vmagent is down
      - alert: VMAgentDown
        expr: |
          up{job="vmagent"} == 0
        for: 2m
        labels:
          severity: critical
          component: monitoring
        annotations:
          summary: "vmagent is down"
          description: |
            vmagent is not responding. Metrics collection and remote write may be affected.
            Check vmagent container status: docker-compose ps vmagent

      # Alert when YACE (AWS exporter) is down
      - alert: YACEDown
        expr: |
          up{job="aws-cloudwatch"} == 0
        for: 5m
        labels:
          severity: warning
          component: monitoring
          cloud: aws
        annotations:
          summary: "AWS CloudWatch exporter (YACE) is down"
          description: |
            YACE exporter is not responding. AWS metrics will not be collected.
            Check YACE container status: docker-compose ps yace

      # Alert when Stackdriver exporter is down
      - alert: StackdriverExporterDown
        expr: |
          up{job="gcp-monitoring"} == 0
        for: 5m
        labels:
          severity: warning
          component: monitoring
          cloud: gcp
        annotations:
          summary: "GCP Stackdriver exporter is down"
          description: |
            Stackdriver exporter is not responding. GCP metrics will not be collected.
            Check stackdriver-exporter container status: docker-compose ps stackdriver-exporter

      # Alert when remote write to Grafana Cloud is failing
      - alert: RemoteWriteFailing
        expr: |
          rate(vmagent_remote_write_errors_total[5m]) > 0
        for: 5m
        labels:
          severity: critical
          component: monitoring
        annotations:
          summary: "Remote write to Grafana Cloud is failing"
          description: |
            vmagent is experiencing errors writing metrics to Grafana Cloud.
            {{ $value }} errors per second detected.
            Check vmagent logs: docker-compose logs vmagent
            Verify Grafana Cloud credentials and network connectivity.

      # Alert when metrics are not being scraped
      - alert: ScrapingFailing
        expr: |
          rate(vmagent_scrape_errors_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
          component: monitoring
        annotations:
          summary: "Metric scraping is failing"
          description: |
            vmagent is experiencing errors scraping metrics from exporters.
            {{ $value }} scrape errors per second detected.
            Check exporter health: docker-compose ps
